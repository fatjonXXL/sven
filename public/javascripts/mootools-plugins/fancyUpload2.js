var FancyUpload2=new Class({Extends:Swiff.Uploader,options:{limitSize:false,limitFiles:5,instantStart:false,allowDuplicates:false,validateFile:$lambda(true),fileInvalid:null,fileCreate:null,fileUpload:null,fileComplete:null,fileRemove:null},initialize:function(a,c,b){this.status=$(a);this.list=$(c);this.files=[];if(b.callBacks){this.addEvents(b.callBacks);b.callBacks=null}this.parent(b);this.render()},render:function(){this.overallTitle=this.status.getElement(".overall-title");this.currentTitle=this.status.getElement(".current-title");this.currentText=this.status.getElement(".current-text");var a=this.status.getElement(".overall-progress");this.overallProgress=new Fx.ProgressBar(a,{text:new Element("span",{"class":"progress-text"}).inject(a,"after")});a=this.status.getElement(".current-progress");this.currentProgress=new Fx.ProgressBar(a,{text:new Element("span",{"class":"progress-text"}).inject(a,"after")})},onLoad:function(){this.log("Uploader ready!")},onBeforeOpen:function(b,a){this.log('Initialize upload for "{name}".',b);var c=this.options.fileUpload;return(c)?c.call(this,this.getFile(b),a):null},onOpen:function(a,b){this.log('Starting upload "{name}".',a);a=this.getFile(a);a.element.addClass("file-uploading");this.currentProgress.cancel().set(0);this.currentTitle.set("html",'File Progress "{name}"'.substitute(a))},onProgress:function(a,c,b){this.overallProgress.start(b.bytesLoaded,b.bytesTotal);this.currentText.set("html","Upload with {rate}/s. Time left: ~{timeLeft}".substitute({rate:(c.rate)?this.sizeToKB(c.rate):"- B",timeLeft:Date.fancyDuration(c.timeLeft||0)}));this.currentProgress.start(c.bytesLoaded,c.bytesTotal)},onSelect:function(b,a,d){var e=[];if(this.options.limitSize&&(b.size>this.options.limitSize)){e.push("size")}if(this.options.limitFiles&&(this.countFiles()>=this.options.limitFiles)){e.push("length")}if(!this.options.allowDuplicates&&this.getFile(b)){e.push("duplicate")}if(!this.options.validateFile.call(this,b,e)){e.push("custom")}if(e.length){var c=this.options.fileInvalid;if(c){c.call(this,b,e)}return false}(this.options.fileCreate||this.fileCreate).call(this,b);this.files.push(b);return true},onAllSelect:function(b,c,a){this.log("Added "+b.length+" files, now we have ("+c.bytesTotal+" bytes).",arguments);this.updateOverall(c.bytesTotal);this.status.removeClass("status-browsing");if(this.files.length&&this.options.instantStart){this.upload.delay(10,this)}},onComplete:function(b,a){this.log('Completed upload "'+b.name+'".',arguments);this.currentText.set("html","Upload complete!");this.currentProgress.start(100);(this.options.fileComplete||this.fileComplete).call(this,this.finishFile(b),a)},onError:function(b,a,c){this.log('Upload "'+b.name+'" failed. "{1}": "{2}".',arguments);(this.options.fileError||this.fileError).call(this,this.finishFile(b),a,c)},onCancel:function(){this.log("Filebrowser cancelled.",arguments);this.status.removeClass("file-browsing")},onAllComplete:function(a){this.log("Completed all files, "+a.bytesTotal+" bytes.",arguments);this.updateOverall(a.bytesTotal);this.overallProgress.start(100);this.status.removeClass("file-uploading")},browse:function(b){var a=this.parent(b);if(a!==true){this.log("Browse in progress.");if(a){alert(a)}}else{this.log("Browse started.");this.status.addClass("file-browsing")}},upload:function(b){var a=this.parent(b);if(a!==true){this.log("Upload in progress or nothing to upload.");if(a){alert(a)}}else{this.log("Upload started.");this.status.addClass("file-uploading");this.overallProgress.set(0)}},removeFile:function(b){var a=this.options.fileRemove||this.fileRemove;if(!b){this.files.each(a,this);this.files.empty();this.updateOverall(0)}else{if(!b.element){b=this.getFile(b)}this.files.erase(b);a.call(this,b);this.updateOverall(this.bytesTotal-b.size)}this.parent(b)},getFile:function(b){var a=null;this.files.some(function(c){if((c.name!=b.name)||(c.size!=b.size)){return false}a=c;return true});return a},countFiles:function(){var b=0;for(var c=0,a=this.files.length;c<a;c++){if(!this.files[c].finished){b++}}return b},updateOverall:function(a){this.bytesTotal=a;this.overallTitle.set("html","Overall Progress ("+this.sizeToKB(a)+")")},finishFile:function(a){a=this.getFile(a);a.element.removeClass("file-uploading");a.finished=true;return a},fileCreate:function(a){a.info=new Element("span",{"class":"file-info"});a.element=new Element("li",{"class":"file"}).adopt(new Element("span",{"class":"file-size",html:this.sizeToKB(a.size)}),new Element("a",{"class":"file-remove",href:"#",html:"Remove",events:{click:function(){this.removeFile(a);return false}.bind(this)}}),new Element("span",{"class":"file-name",html:a.name}),a.info).inject(this.list)},fileComplete:function(c,a){this.options.processResponse||this;var b=$H(JSON.decode(a,true));if(b.get("result")=="success"){c.element.addClass("file-success");c.info.set("html",b.get("size"))}else{c.element.addClass("file-failed");c.info.set("html",b.get("error")||a)}},fileError:function(b,a,c){b.element.addClass("file-failed");b.info.set("html","<strong>"+a+"</strong><br />"+c)},fileRemove:function(a){a.element.fade("out").retrieve("tween").chain(Element.destroy.bind(Element,a.element))},sizeToKB:function(a){var b="B";if((a/1048576)>1){b="MB";a/=1048576}else{if((a/1024)>1){b="kB";a/=1024}}return a.round(1)+" "+b},log:function(b,a){if(window.console){console.log(b.substitute(a||{}))}}});Date.parseDuration=function(b){var a={},e=Date.durations;for(var c in e){var d=Math.floor(b/e[c]);if(d){a[c]=d;if(!(b-=d*e[c])){break}}}return a};Date.fancyDuration=function(c){var b=[],a=Date.parseDuration(c);for(var d in a){b.push(a[d]+Date.durationsAbbr[d])}return b.join(", ")};Date.durations={years:31556926,months:2629743.83,days:86400,hours:3600,minutes:60,seconds:1,milliseconds:0.001};Date.durationsAbbr={years:"j",months:"m",days:"d",hours:"h",minutes:"min",seconds:"sec",milliseconds:"ms"};